// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


// 11 Roles defined in Section 2.2 of your design
enum UserRole {
  STUDENT
  FACULTY
  CLASS_COORDINATOR
  HOD
  HOSTEL_WARDEN
  LIBRARY_ADMIN
  WORKSHOP_ADMIN
  TP_OFFICER
  GENERAL_OFFICE
  ACCOUNTS_OFFICER
  SUPER_ADMIN
}

enum ApplicationStatus {
  IN_PROGRESS
  SUBMITTED
  FULLY_APPROVED
  REJECTED
}

enum ApprovalStatus {
  UNDER_REVIEW
  APPROVED
  REJECTED
}

model User {
  id            String        @id @default(cuid())
  email         String        @unique
  password      String        // bcrypt hashed password
  enrollmentNo  String?       @unique 
  name          String
  role          UserRole      @default(STUDENT)
  department    String?  
  createdAt     DateTime      @default(now())

  applications  Application[] @relation("StudentApplications")
}

model Application {
  id                String            @id @default(cuid())
  applicationNo     String            @unique
  studentId         String
  student           User              @relation("StudentApplications", fields: [studentId], references: [id])
  status            ApplicationStatus @default(IN_PROGRESS)
  
  // Section 3: Application Process Details
  fullName          String
  fatherName        String
  phoneNumber       String
  address           String
  passOutYear       Int
  course            String
  cgpa              Float
  
  // Hostel & Caution Money Logic
  isHostelResident  Boolean           @default(false)
  hostelName        String?
  roomNumber        String?
  cautionMoneyRefund Boolean          @default(false)
  receiptNumber     String?
  
  // Document Uploads
  feeReceipts       String[]
  marksheet         String?
  bankDetails       String?
  collegeId         String?

  // Workflow tracking
  currentStage      Int               @default(1) 
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  
  approvals         Approval[]

  @@index([studentId])
}

model Approval {
  id            String         @id @default(cuid())
  applicationId String
  stage         Int
  department    String
  status        ApprovalStatus @default(UNDER_REVIEW)
  remarks       String?        
  actionDate    DateTime?
  approvedBy    String?        // User ID of the staff who took action
  
  application   Application    @relation(fields: [applicationId], references: [id])

  @@index([applicationId])
  @@index([department, stage, status])
}